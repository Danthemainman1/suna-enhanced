# Suna Ultra - Production Deployment Guide

Complete production deployment infrastructure for self-hosting Suna Ultra on any server.

## üöÄ Quick Start (3 Commands)

```bash
# 1. Navigate to scripts
cd deploy/scripts

# 2. Run setup (creates config, generates secrets, starts services)
./setup.sh

# 3. Verify health
./health-check.sh
```

That's it! Your Suna Ultra instance is running at:
- API: http://localhost/api
- Docs: http://localhost/docs

## üì¶ What's Included

### Docker Compose

Production-ready Docker setup with:
- ‚úÖ **nginx**: Reverse proxy with rate limiting and SSL support
- ‚úÖ **backend**: FastAPI application with Gunicorn + Uvicorn
- ‚úÖ **worker**: Dramatiq background workers (scalable)
- ‚úÖ **postgres**: PostgreSQL 15 with persistent storage
- ‚úÖ **redis**: Redis 7 with AOF persistence

[Docker Documentation ‚Üí](docker/README.md)

### Kubernetes

Enterprise-grade K8s manifests with:
- ‚úÖ **Auto-scaling**: HPA for backend and workers
- ‚úÖ **High availability**: Multi-replica deployments
- ‚úÖ **Persistent storage**: PVCs for database and cache
- ‚úÖ **Ingress**: NGINX with TLS support
- ‚úÖ **Health checks**: Liveness and readiness probes

[Kubernetes Documentation ‚Üí](kubernetes/README.md)

### Automation Scripts

Utility scripts for operations:
- `setup.sh` - One-command initial setup
- `deploy.sh` - Zero-downtime deployments
- `backup.sh` - Automated backups (PostgreSQL + Redis)
- `restore.sh` - Disaster recovery
- `health-check.sh` - Service monitoring

## üìã Prerequisites

### Minimum Requirements

- **OS**: Ubuntu 20.04+ / Debian 11+ / CentOS 8+
- **RAM**: 8GB minimum (16GB recommended)
- **CPU**: 2 cores (4+ recommended)
- **Disk**: 20GB free space
- **Docker**: 20.10+
- **Docker Compose**: v2.0+ (or docker-compose v1.29+)

### For Kubernetes

- **Kubernetes**: 1.24+
- **kubectl**: Configured and connected
- **Ingress Controller**: NGINX
- **cert-manager**: For automatic TLS certificates

## üê≥ Docker Deployment

### Step 1: Configure Environment

```bash
cd deploy/docker
cp .env.example .env
```

Edit `.env` and add your configuration:

```bash
# Required
ANTHROPIC_API_KEY=sk-ant-xxx
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...
SUPABASE_JWT_SECRET=your-jwt-secret

# Auto-generated by setup.sh
SECRET_KEY=<auto-generated>
DB_PASSWORD=<auto-generated>
```

### Step 2: Run Setup

```bash
cd deploy/scripts
./setup.sh
```

The script will:
1. Generate secure random secrets
2. Pull Docker images
3. Start all services
4. Wait for services to be healthy
5. Verify API is accessible

### Step 3: Access Your Instance

- **API**: http://localhost/api
- **Docs**: http://localhost/docs
- **Health**: http://localhost/health

### Common Commands

```bash
# View logs
docker compose -f deploy/docker/docker-compose.prod.yml logs -f

# Restart services
docker compose -f deploy/docker/docker-compose.prod.yml restart

# Stop services
docker compose -f deploy/docker/docker-compose.prod.yml down

# Update to latest version
cd deploy/scripts && ./deploy.sh
```

## ‚ò∏Ô∏è Kubernetes Deployment

### Step 1: Create Namespace

```bash
kubectl apply -f deploy/kubernetes/namespace.yaml
```

### Step 2: Configure Secrets

```bash
kubectl create secret generic suna-secrets \
  --namespace=suna-ultra \
  --from-literal=ANTHROPIC_API_KEY=sk-ant-xxx \
  --from-literal=SECRET_KEY=$(openssl rand -hex 32) \
  --from-literal=DB_PASSWORD=$(openssl rand -hex 16) \
  --from-literal=SUPABASE_URL=https://xxx.supabase.co \
  --from-literal=SUPABASE_ANON_KEY=eyJ... \
  --from-literal=SUPABASE_SERVICE_ROLE_KEY=eyJ... \
  --from-literal=SUPABASE_JWT_SECRET=xxx
```

### Step 3: Deploy Infrastructure

```bash
# Configuration
kubectl apply -f deploy/kubernetes/configmap.yaml

# Storage
kubectl apply -f deploy/kubernetes/postgres/pvc.yaml
kubectl apply -f deploy/kubernetes/redis/pvc.yaml

# Databases
kubectl apply -f deploy/kubernetes/postgres/
kubectl apply -f deploy/kubernetes/redis/
```

### Step 4: Deploy Application

```bash
# Backend and workers
kubectl apply -f deploy/kubernetes/backend/
kubectl apply -f deploy/kubernetes/worker/
```

### Step 5: Configure Ingress

Edit `deploy/kubernetes/ingress.yaml` with your domain:

```yaml
spec:
  tls:
  - hosts:
    - suna.yourdomain.com
  rules:
  - host: suna.yourdomain.com
```

Apply ingress:

```bash
kubectl apply -f deploy/kubernetes/ingress.yaml
```

### Verify Deployment

```bash
# Check pods
kubectl get pods -n suna-ultra

# Check services
kubectl get svc -n suna-ultra

# Port forward for testing
kubectl port-forward -n suna-ultra svc/suna-backend 8000:8000
```

## üîí SSL/TLS Setup

### Let's Encrypt (Recommended)

#### Docker

```bash
# Install certbot
sudo apt-get install certbot

# Generate certificates
sudo certbot certonly --standalone -d yourdomain.com

# Copy to nginx
sudo cp /etc/letsencrypt/live/yourdomain.com/fullchain.pem \
  deploy/docker/nginx/ssl/cert.pem
sudo cp /etc/letsencrypt/live/yourdomain.com/privkey.pem \
  deploy/docker/nginx/ssl/key.pem

# Update nginx config (uncomment HTTPS server block)
# Then restart
docker compose -f deploy/docker/docker-compose.prod.yml restart nginx
```

#### Kubernetes

With cert-manager installed:

```bash
# Ingress already configured with cert-manager annotation
kubectl apply -f deploy/kubernetes/ingress.yaml

# Certificate will be automatically provisioned
kubectl get certificate -n suna-ultra
```

## üíæ Backup & Restore

### Automated Backups

```bash
# Create backup
cd deploy/scripts
./backup.sh ./backups

# Schedule daily backups (add to crontab)
0 2 * * * /path/to/deploy/scripts/backup.sh /backups/suna-ultra
```

Backups include:
- PostgreSQL database dump (SQL)
- Redis snapshot (RDB)
- Timestamped filenames

### Restore from Backup

```bash
cd deploy/scripts
./restore.sh ./backups/db_20240101_120000.sql
```

## üìä Monitoring

### Health Checks

```bash
cd deploy/scripts
./health-check.sh
```

Output:
```
üè• Health Check
===============

‚úÖ Backend API
‚úÖ API Docs

üìä Container Status:
...
```

### View Logs

#### Docker

```bash
# All services
docker compose -f deploy/docker/docker-compose.prod.yml logs -f

# Specific service
docker compose -f deploy/docker/docker-compose.prod.yml logs -f backend

# Last 100 lines
docker compose -f deploy/docker/docker-compose.prod.yml logs --tail=100
```

#### Kubernetes

```bash
# All backend pods
kubectl logs -n suna-ultra -l app=suna-backend -f

# Specific pod
kubectl logs -n suna-ultra <pod-name> -f

# Previous container
kubectl logs -n suna-ultra <pod-name> --previous
```

### Resource Usage

#### Docker

```bash
docker stats
docker system df
```

#### Kubernetes

```bash
kubectl top nodes
kubectl top pods -n suna-ultra
```

## üîß Troubleshooting

### Services Not Starting

1. **Check logs**:
   ```bash
   docker compose -f deploy/docker/docker-compose.prod.yml logs
   ```

2. **Verify configuration**:
   ```bash
   cat deploy/docker/.env
   ```

3. **Check disk space**:
   ```bash
   df -h
   docker system df
   ```

### Connection Issues

1. **Test services individually**:
   ```bash
   # Backend
   curl http://localhost/health
   
   # Direct backend (Docker)
   docker compose exec backend curl http://localhost:8000/health
   ```

2. **Check network**:
   ```bash
   docker network ls
   docker network inspect deploy_suna-network
   ```

### Database Issues

1. **Test PostgreSQL**:
   ```bash
   docker compose exec postgres pg_isready -U suna
   ```

2. **Test Redis**:
   ```bash
   docker compose exec redis redis-cli ping
   ```

3. **Reset database** (‚ö†Ô∏è data loss):
   ```bash
   docker compose down -v
   docker compose up -d
   ```

### Out of Memory

1. **Check memory**:
   ```bash
   free -h
   docker stats --no-stream
   ```

2. **Reduce workers**:
   Edit `docker-compose.prod.yml`:
   ```yaml
   worker:
     deploy:
       replicas: 1  # Reduce from 2
   ```

3. **Adjust limits**:
   ```yaml
   services:
     backend:
       deploy:
         resources:
           limits:
             memory: 256M  # Reduce
   ```

## üöÄ Upgrading

### Zero-Downtime Update

```bash
cd deploy/scripts
./deploy.sh
```

This will:
1. Pull latest images
2. Build new images
3. Restart services with no downtime
4. Verify health

### Manual Update

```bash
# Pull latest code
git pull origin main

# Docker
cd deploy/docker
docker compose -f docker-compose.prod.yml build
docker compose -f docker-compose.prod.yml up -d

# Kubernetes
kubectl set image deployment/suna-backend \
  backend=suna-ultra/backend:latest \
  -n suna-ultra
```

## üîê Security Best Practices

### 1. Strong Secrets

```bash
# Generate secure secrets
openssl rand -hex 32  # SECRET_KEY
openssl rand -hex 16  # DB_PASSWORD
```

### 2. Use HTTPS

Always enable SSL/TLS in production (see SSL Setup).

### 3. Firewall

```bash
# Allow only HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### 4. Regular Updates

```bash
# Weekly image updates
docker compose pull
docker compose up -d
```

### 5. Backup Schedule

Set up automated daily backups (see Backup section).

### 6. Monitor Logs

Configure log rotation:

```json
// /etc/docker/daemon.json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

## üìà Performance Tuning

### Backend Workers

Adjust based on CPU cores:

```yaml
backend:
  environment:
    - WORKERS=7  # Formula: (2 * CPU_CORES) + 1
```

### Scale Workers

```bash
# Docker
docker compose up -d --scale worker=4

# Kubernetes (HPA handles this automatically)
kubectl scale deployment suna-worker -n suna-ultra --replicas=4
```

### Database Optimization

```yaml
postgres:
  command: >
    postgres
    -c max_connections=100
    -c shared_buffers=256MB
    -c effective_cache_size=1GB
```

### Redis Configuration

```yaml
redis:
  command: >
    redis-server
    --appendonly yes
    --maxmemory 512mb
    --maxmemory-policy allkeys-lru
```

## üåê Remote Access

### Dynamic DNS

For home servers with dynamic IPs:

1. **No-IP / DuckDNS**:
   - Sign up for free dynamic DNS
   - Install updater client
   - Configure domain

2. **Port Forwarding**:
   - Forward ports 80 and 443 to your server
   - Configure your router/firewall

### Reverse Proxy

Use Cloudflare or similar:
- DDoS protection
- SSL/TLS termination
- CDN capabilities

## üìö Additional Resources

- [Docker Deployment Guide](docker/README.md)
- [Kubernetes Deployment Guide](kubernetes/README.md)
- [Self-Hosting Guide](../docs/SELF_HOSTING_GUIDE.md)
- [Main Documentation](../docs/)

## üÜò Support

- **Documentation**: [/docs](../docs/)
- **Issues**: [GitHub Issues](https://github.com/Danthemainman1/suna-enhanced/issues)
- **Discord**: [Join Community](https://discord.gg/RvFhXUdZ9H)
- **Twitter**: [@kortix](https://x.com/kortix)

## üìÑ License

Apache License 2.0 - See [LICENSE](../LICENSE)

---

**Built with ‚ù§Ô∏è by the Suna Ultra community**

Self-host your AI agents with confidence. Full control, zero vendor lock-in.
