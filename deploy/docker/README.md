# Suna Ultra - Docker Deployment

Production-ready Docker Compose configuration for self-hosting Suna Ultra on any server.

## Quick Start

### Prerequisites

- Docker 20.10+
- Docker Compose v2.0+ (or docker-compose v1.29+)
- 8GB RAM minimum (16GB recommended)
- 20GB disk space

### 1️⃣ Setup

Run the automated setup script:

```bash
cd deploy/scripts
./setup.sh
```

The script will:
- Create `.env` file with secure random secrets
- Pull required Docker images
- Start all services
- Verify health

### 2️⃣ Configure

Edit `deploy/docker/.env` and add your API keys:

```bash
# Required
ANTHROPIC_API_KEY=sk-ant-...
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...
SUPABASE_JWT_SECRET=your-jwt-secret

# Auto-generated (don't change)
SECRET_KEY=<auto-generated>
DB_PASSWORD=<auto-generated>
```

### 3️⃣ Start

```bash
cd deploy/scripts
./setup.sh
```

Access your instance at:
- API: http://localhost/api
- Docs: http://localhost/docs

## Services

### Production Stack

- **nginx**: Reverse proxy with rate limiting and SSL support
- **backend**: FastAPI application (Gunicorn + Uvicorn workers)
- **worker**: Dramatiq background workers (2 replicas)
- **postgres**: PostgreSQL 15 database with persistence
- **redis**: Redis 7 cache and message broker with AOF persistence

### Development Stack

Use `docker-compose.dev.yml` for local development with:
- Hot reload support
- Exposed ports for debugging
- Volume mounts for live code changes
- Single worker instance

```bash
docker compose -f docker-compose.dev.yml up -d
```

## Configuration

### Environment Variables

All configuration is in `.env` file. Key variables:

```bash
# LLM Providers (at least one required)
ANTHROPIC_API_KEY=
OPENAI_API_KEY=
GROQ_API_KEY=

# Database
SUPABASE_URL=
SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
SUPABASE_JWT_SECRET=

# Security
SECRET_KEY=<auto-generated>
DB_PASSWORD=<auto-generated>

# Optional
DOMAIN=yourdomain.com
```

### Resource Limits

Edit `docker-compose.prod.yml` to adjust:

```yaml
services:
  backend:
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
```

## SSL/TLS Setup

### Let's Encrypt (Recommended)

1. Install certbot:
```bash
sudo apt-get install certbot
```

2. Generate certificates:
```bash
sudo certbot certonly --standalone -d yourdomain.com
```

3. Copy certificates:
```bash
sudo cp /etc/letsencrypt/live/yourdomain.com/fullchain.pem deploy/docker/nginx/ssl/cert.pem
sudo cp /etc/letsencrypt/live/yourdomain.com/privkey.pem deploy/docker/nginx/ssl/key.pem
```

4. Uncomment HTTPS server block in `nginx/nginx.conf`

5. Restart nginx:
```bash
docker compose -f docker-compose.prod.yml restart nginx
```

### Self-Signed Certificates

For testing only:

```bash
cd deploy/docker/nginx/ssl
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout key.pem -out cert.pem \
  -subj "/CN=localhost"
```

## Operations

### View Logs

```bash
# All services
docker compose -f docker-compose.prod.yml logs -f

# Specific service
docker compose -f docker-compose.prod.yml logs -f backend

# Last 100 lines
docker compose -f docker-compose.prod.yml logs --tail=100
```

### Restart Services

```bash
# All services
docker compose -f docker-compose.prod.yml restart

# Specific service
docker compose -f docker-compose.prod.yml restart backend
```

### Stop Services

```bash
docker compose -f docker-compose.prod.yml down
```

### Scale Workers

```bash
docker compose -f docker-compose.prod.yml up -d --scale worker=4
```

## Backup & Restore

### Backup

```bash
cd deploy/scripts
./backup.sh ./backups
```

Creates timestamped backups:
- `db_YYYYMMDD_HHMMSS.sql` - PostgreSQL dump
- `redis_YYYYMMDD_HHMMSS.rdb` - Redis snapshot

### Restore

```bash
cd deploy/scripts
./restore.sh ./backups/db_20240101_120000.sql
```

### Automated Backups

Add to crontab:

```bash
# Daily backup at 2 AM
0 2 * * * /path/to/deploy/scripts/backup.sh /backups/suna-ultra
```

## Monitoring

### Health Check

```bash
cd deploy/scripts
./health-check.sh
```

### Container Stats

```bash
docker stats
```

### Resource Usage

```bash
docker compose -f docker-compose.prod.yml ps
docker system df
```

## Troubleshooting

### Services Not Starting

1. Check logs:
```bash
docker compose -f docker-compose.prod.yml logs
```

2. Verify configuration:
```bash
cat .env | grep -v "^#" | grep .
```

3. Check disk space:
```bash
df -h
docker system df
```

### Connection Refused

1. Verify services are running:
```bash
docker compose -f docker-compose.prod.yml ps
```

2. Check network:
```bash
docker network ls
docker network inspect deploy_suna-network
```

3. Test backend directly:
```bash
docker compose -f docker-compose.prod.yml exec backend curl http://localhost:8000/health
```

### Database Connection Issues

1. Check PostgreSQL:
```bash
docker compose -f docker-compose.prod.yml exec postgres pg_isready -U suna
```

2. Verify credentials in `.env`

3. Reset database:
```bash
docker compose -f docker-compose.prod.yml down -v
docker compose -f docker-compose.prod.yml up -d
```

### Out of Memory

1. Check memory usage:
```bash
free -h
docker stats --no-stream
```

2. Reduce worker count:
```yaml
# docker-compose.prod.yml
worker:
  deploy:
    replicas: 1  # Reduce from 2
```

3. Adjust container limits:
```yaml
services:
  backend:
    deploy:
      resources:
        limits:
          memory: 256M  # Reduce from 512M
```

## Upgrading

### Rolling Update

```bash
cd deploy/scripts
./deploy.sh
```

This performs zero-downtime deployment:
1. Pull latest images
2. Build new images
3. Restart backend and workers
4. Health check

### Manual Update

```bash
cd deploy/docker

# Pull latest code
git pull origin main

# Rebuild and restart
docker compose -f docker-compose.prod.yml build
docker compose -f docker-compose.prod.yml up -d
```

## Security Best Practices

### 1. Use Strong Secrets

```bash
# Generate new secrets
openssl rand -hex 32  # SECRET_KEY
openssl rand -hex 16  # DB_PASSWORD
```

### 2. Enable HTTPS

Always use SSL/TLS in production (see SSL Setup above).

### 3. Firewall Rules

```bash
# Allow only HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### 4. Regular Updates

```bash
# Update base images weekly
docker compose -f docker-compose.prod.yml pull
docker compose -f docker-compose.prod.yml up -d
```

### 5. Backup Regularly

Schedule automated backups (see Backup section above).

### 6. Monitor Logs

Set up log rotation:

```bash
# /etc/docker/daemon.json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

## Performance Tuning

### Backend Workers

Adjust based on CPU cores:

```yaml
# docker-compose.prod.yml
backend:
  environment:
    - WORKERS=7  # (2 * CPU) + 1
```

### Worker Processes

Scale based on workload:

```yaml
worker:
  command: uv run dramatiq --processes 4 --threads 4 run_agent_background
  deploy:
    replicas: 2
```

### Database Connections

Optimize PostgreSQL:

```yaml
postgres:
  command: postgres -c max_connections=100 -c shared_buffers=256MB
```

### Redis Memory

Set max memory:

```yaml
redis:
  command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
```

## Advanced Configuration

### Custom nginx Config

Edit `nginx/nginx.conf` for:
- Additional locations
- Custom rate limits
- SSL settings
- Caching policies

### External Database

Use external PostgreSQL:

```yaml
# docker-compose.prod.yml
backend:
  environment:
    - DATABASE_URL=postgresql://user:pass@external-host:5432/dbname
```

Remove `postgres` service and its dependencies.

### External Redis

Use managed Redis:

```yaml
backend:
  environment:
    - REDIS_URL=redis://redis.cloud.example.com:6379
    - REDIS_SSL=True
```

Remove `redis` service.

## Support

- Documentation: [/docs](../../docs/)
- Issues: [GitHub Issues](https://github.com/Danthemainman1/suna-enhanced/issues)
- Discord: [Join Community](https://discord.gg/RvFhXUdZ9H)

## License

Apache License 2.0 - See [LICENSE](../../LICENSE)
